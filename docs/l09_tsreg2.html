<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Time Series Analysis - 9&nbsp; Time Series Regression with Correlated Errors</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./l13_spectral.html" rel="next">
<link href="./l08_tsreg1.html" rel="prev">
<link href="./TSAfav.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Regression with Correlated Errors</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Time Series Analysis</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vlyubchich/tsar/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l01_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Review of Linear Regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l02_tsintro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Time Series Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l03_smoothing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Smoothing, Detrending, and Deseasonalizing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l04_arma.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autoregressive Moving Average (ARMA) Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l05_arima.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Autoregressive Integrated Moving Average (ARIMA) Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l06_garch.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Generalized Autoregressive Conditional Heteroskedasticity (GARCH) Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l07_trendtest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Trend Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l08_tsreg1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Time Series Regression with Trends</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l09_tsreg2.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Regression with Correlated Errors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l13_spectral.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spectral Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software.html" class="sidebar-item-text sidebar-link">Software</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s1_wls.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Weighted least squares</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s2_gls.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Generalized least squares</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s4_trendsync.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Synchrony of parametric trends</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s_practice.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Practice exercises</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">9.1</span>  Introduction</a></li>
  <li><a href="#sec-ccf" id="toc-sec-ccf" class="nav-link" data-scroll-target="#sec-ccf"><span class="toc-section-number">9.2</span>  Cross-correlation function</a></li>
  <li><a href="#linear-regression-with-arma-errors" id="toc-linear-regression-with-arma-errors" class="nav-link" data-scroll-target="#linear-regression-with-arma-errors"><span class="toc-section-number">9.3</span>  Linear regression with ARMA errors</a></li>
  <li><a href="#arimax" id="toc-arimax" class="nav-link" data-scroll-target="#arimax"><span class="toc-section-number">9.4</span>  ARIMAX</a></li>
  <li><a href="#sec-GARMA" id="toc-sec-GARMA" class="nav-link" data-scroll-target="#sec-GARMA"><span class="toc-section-number">9.5</span>  GARMA</a></li>
  <li><a href="#sec-GAMLSS" id="toc-sec-GAMLSS" class="nav-link" data-scroll-target="#sec-GAMLSS"><span class="toc-section-number">9.6</span>  GAMLSS</a></li>
  <li><a href="#sec-Granger" id="toc-sec-Granger" class="nav-link" data-scroll-target="#sec-Granger"><span class="toc-section-number">9.7</span>  Granger causality</a></li>
  <li><a href="#about-predictions" id="toc-about-predictions" class="nav-link" data-scroll-target="#about-predictions"><span class="toc-section-number">9.8</span>  About predictions</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="toc-section-number">9.9</span>  Conclusion</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/vlyubchich/tsar/edit/master/l09_tsreg2.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/vlyubchich/tsar/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Regression with Correlated Errors</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>The goal of this lecture is to bring together knowledge about regression, time series trends, and autocorrelation with the goal of obtaining correct inference in regression problems involving time series. You should become capable of suggesting a model that would meet the goal of data analysis (testing certain relationships) while satisfying assumptions (e.g., uncorrelatedness of residuals) and minimizing the risk of spurious results.</p>
<p><strong>Objectives</strong></p>
<ol type="1">
<li>Model autocorrelated residuals (in other words, incorporate or account for autocorrelation) so the final residuals satisfy modeling assumptions.</li>
<li>Apply and interpret Granger causality that is based on time series predictability.</li>
</ol>
<p><strong>Reading materials</strong></p>
<ul>
<li>Chapters 3.8, 5.5, and 5.6 in <span class="citation" data-cites="Shumway:Stoffer:2017">Shumway and Stoffer (<a href="references.html#ref-Shumway:Stoffer:2017" role="doc-biblioref">2017</a>)</span>
</li>
<li>Chapter 3 in <span class="citation" data-cites="Kirchgassner:Wolters:2007">Kirchgässner and Wolters (<a href="references.html#ref-Kirchgassner:Wolters:2007" role="doc-biblioref">2007</a>)</span> on Granger causality</li>
</ul>
<section id="introduction" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">9.1</span> Introduction</h2>
<p>Here we explore a regression model with autocorrelated residuals. We already know how to</p>
<ul>
<li>forecast, construct prediction intervals, and test hypotheses about regression coefficients when the residuals satisfy the ordinary least squares (OLS) assumptions, i.e., the residuals are white noise and have a joint normal distribution <span class="math inline">\(N(0, \sigma^{2})\)</span>;</li>
<li>model serial dependence (i.e., autocorrelation) in stationary univariate time series, such as using ARMA models.</li>
</ul>
<p>Here we bring these two skills together.</p>
<p>If the residuals do not satisfy the independence assumption, we can sometimes describe them in terms of a specific correlation model involving one or more new parameters and some ‘new residuals.’ These new residuals essentially satisfy the OLS assumptions and can replace the original correlated residuals (which we will sometimes call the ‘old’ residuals) in the model.</p>
<p>When modeling time series, we often want to find so-called <em>leading indicators</em>, i.e., exogenous variables whose lagged values can be used for predicting the response, so for the forecasts we do not need to predict <span class="math inline">\(X\)</span>-variables that are employed in a model. Hence, our models may include lagged versions of both the response and predictor variables (a general form of such a model was given in <a href="l02_tsintro.html#eq-fmult">Equation&nbsp;<span>2.2</span></a>).</p>
</section><section id="sec-ccf" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="sec-ccf">
<span class="header-section-number">9.2</span> Cross-correlation function</h2>
<p>Cross-correlation is a correlation between different time series, typically with a time offset <span class="math inline">\(k\)</span> (a.k.a. lag): <span id="eq-ccf"><span class="math display">\[
\mathrm{cor}(X_{t+k},Y_t).
\tag{9.1}\]</span></span> (Recall that autocorrelation is also a correlation with a lag present, but for the same time series.) By calculating cross-correlations at each lag <span class="math inline">\(k = 0, \pm 1, \pm 2, \dots\)</span>, we obtain the <em>cross-correlation function</em> (CCF). CCF shows how the correlation coefficient varies with the lag <span class="math inline">\(k\)</span> and helps us to identify important lags and find leading indicators for predictive models. For example, the relationship between nutrient input and algal blooms in a marine environment is not immediate since the algae need time to reproduce. The correlation between a time series of births and demand for baby formula would be distributed over smaller lags <span class="math inline">\(l\)</span> <span class="math display">\[
\mathrm{cor}(\mathrm{Births}_{t - l}, \mathrm{FormulaDemand}_t)
\]</span> than the correlation lags <span class="math inline">\(L\)</span> between births and school enrollments <span class="math display">\[
\mathrm{cor}(\mathrm{Births}_{t - L}, \mathrm{SchoolEnrollment}_t),
\]</span> where <span class="math inline">\(l,L &gt; 0\)</span> and <span class="math inline">\(l &lt; L\)</span>.</p>
<p>The functions <code><a href="https://rdrr.io/r/stats/acf.html">ccf()</a></code> and <code><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">forecast::ggCcf()</a></code> estimate the cross-correlation function and plot it as a base-R or a <code>ggplot2</code> graph, respectively. The functions use the notations like in <a href="#eq-ccf">Equation&nbsp;<span>9.1</span></a>, hence when using <code>ccf(x, y)</code> we are typically interested in identifying <em>negative</em> <span class="math inline">\(k\)</span>s that correspond to correlation between past values of the predictor <span class="math inline">\(X_t\)</span> and current values of the response <span class="math inline">\(Y_t\)</span>.</p>
<p>For example, <a href="#fig-CCFBJ">Figure&nbsp;<span>9.1</span></a> shows the CCF for two time series of sales that have been detrended by taking differences. From this plot, lagged values of the first series, <span class="math inline">\(\Delta \mathrm{BJsales.lead}_{t - 2}\)</span> and <span class="math inline">\(\Delta \mathrm{BJsales.lead}_{t - 3}\)</span> are significantly correlated with current values of the second series, <span class="math inline">\(\Delta \mathrm{BJsales}_{t}\)</span>. Hence, we can call <code>BJsales.lead</code> a leading indicator for <code>BJsales</code>.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggCcf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales.lead</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-CCFBJ" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-CCFBJ-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.1: Cross-correlation function of the detrended time series.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The function <code><a href="https://rdrr.io/r/stats/acf.html">ccf()</a></code> assumes that the two time series are evenly spaced and have no missing data. We can use the argument <code>na.action = na.pass</code> to ignore any missing values.</p>
</div>
</div>
<p>Note that the 95% confidence band shown in <a href="#fig-CCFBJ">Figure&nbsp;<span>9.1</span></a> is based on how i.i.d. series of length <span class="math inline">\(n\)</span> would correlate (the same way the band is produced for an autocorrelation function with <code><a href="https://rdrr.io/r/stats/acf.html">acf()</a></code>). However, when <span class="math inline">\(n\)</span> is small, there are not so many pairs <span class="math inline">\((X_{t+k}, Y_t)\)</span> to calculate the correlations at large lags, hence the confidence bands should be adjusted by using the smaller <span class="math inline">\(n'(k) = n - |k|\)</span> to account for this lack of confidence.</p>
<p>Another concern is the autocorrelation of individual time series that may lead to spurious cross-correlation <span class="citation" data-cites="Dean:Dunsmuir:2016">(<a href="references.html#ref-Dean:Dunsmuir:2016" role="doc-biblioref">Dean and Dunsmuir 2016</a>)</span>. Intuitively, say if <span class="math inline">\(X_t\)</span> and <span class="math inline">\(Y_t\)</span> are independent from each other but both <span class="math inline">\(X_t\)</span> and <span class="math inline">\(Y_t\)</span> are positively autocorrelated – high (or low) values in <span class="math inline">\(X_t\)</span> follow each other, and high (or low) values in <span class="math inline">\(Y_t\)</span> follow each other – there could be a time alignment among our considered lags <span class="math inline">\(k = 0, \pm 1, \pm 2, \dots\)</span> when the ups (or downs) in <span class="math inline">\(X_{t+k}\)</span> match those in <span class="math inline">\(Y_t\)</span>. This may result in spurious cross-correlation. To address the concern of autocorrelation, we can apply bootstrapping to approximate the distribution of cross-correlation coefficients corresponding not to the i.i.d. series but to stationary time series with the same autocorrelation structure as the input data. The function <code><a href="https://rdrr.io/pkg/funtimes/man/ccf_boot.html">funtimes::ccf_boot()</a></code> implements the sieve bootstrap and returns results for both Pearson and Spearman correlations (<a href="#fig-CCFbootBJ">Figure&nbsp;<span>9.2</span></a>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">funtimes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/funtimes/man/ccf_boot.html">ccf_boot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales.lead</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales</span><span class="op">)</span>, </span>
<span>                          B <span class="op">=</span> <span class="fl">10000</span>, plot <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Lag</span>, y <span class="op">=</span> <span class="va">r_P</span>, xend <span class="op">=</span> <span class="va">Lag</span>, yend <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_P</span>, ymax <span class="op">=</span> <span class="va">upper_P</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Pearson correlation"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Lag</span>, y <span class="op">=</span> <span class="va">r_S</span>, xend <span class="op">=</span> <span class="va">Lag</span>, yend <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_S</span>, ymax <span class="op">=</span> <span class="va">upper_S</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Spearman correlation"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-CCFbootBJ" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-CCFbootBJ-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.2: Pearson and Spearman cross-correlation functions of the detrended time series with sieve bootstrap confidence intervals. Note that the function <code><a href="https://rdrr.io/pkg/funtimes/man/ccf_boot.html">funtimes::ccf_boot()</a></code> automatically produces a base-R plot that was suppressed here to save the results as the object <code>res</code> and use the package <code>ggplot2</code> for the plots.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Finally, remember that the reported Pearson correlations in <a href="#fig-CCFBJ">Figure&nbsp;<span>9.1</span></a> and <a href="#fig-CCFbootBJ">Figure&nbsp;<span>9.2</span></a> A measure the direction and strength of <em>linear</em> relationships, while Spearman correlations in <a href="#fig-CCFbootBJ">Figure&nbsp;<span>9.2</span></a> B correspond to <em>monotonic</em> relationships. To further investigate whether the lagged relationships are linear, monotonic, or of some other form, we need to plot the lagged scatterplots (<a href="#fig-lagCCF">Figure&nbsp;<span>9.3</span></a>). Also see other functions in the package <code>astsa</code>, such as the function <code><a href="https://rdrr.io/pkg/astsa/man/lag1.plot.html">astsa::lag1.plot()</a></code> for exploring nonlinear autocorrelations.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">astsa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/astsa/man/lag2.plot.html">lag2.plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales.lead</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">BJsales</span><span class="op">)</span>, max.lag <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-lagCCF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-lagCCF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.3: Lagged scatterplots of the detrended time series with lowess smooths and (linear) Pearson correlations reported in the right corners.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="linear-regression-with-arma-errors" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="linear-regression-with-arma-errors">
<span class="header-section-number">9.3</span> Linear regression with ARMA errors</h2>
<p>We begin with the simplest case, a <em>constant mean model</em>, where the residuals are serially correlated and follow an AR(1) model, that is <span id="eq-constmean"><span class="math display">\[
Y_{t} = \beta_{0} + \epsilon_{t},
\tag{9.2}\]</span></span> where <span class="math inline">\(\epsilon_{t} \sim\)</span> AR(1), i.e., <span id="eq-ar1resid"><span class="math display">\[
\epsilon_{t} = \phi \epsilon_{t - 1} + a_{t}.
\tag{9.3}\]</span></span></p>
<p>Here <span class="math inline">\(\phi\)</span> is a real number satisfying <span class="math inline">\(0 &lt; |\phi| &lt; 1\)</span>; <span class="math inline">\(a_{t}\)</span> is white noise with zero mean and the variance <span class="math inline">\(\nu^{2}\)</span>, i.e., <span class="math inline">\(a_{t} \sim \mathrm{WN}(0,\nu^2)\)</span>. We also assume that <span class="math inline">\(\mathrm{cov}(a_{t}, \epsilon_{s}) = 0\)</span> for all <span class="math inline">\(s &lt; t\)</span> (i.e., that the residuals <span class="math inline">\(\epsilon_s\)</span> are not correlated with the future white noise <span class="math inline">\(a_t\)</span>).</p>
<p><a href="#eq-ar1resid">Equation&nbsp;<span>9.3</span></a> allows us to express <a href="#eq-constmean">Equation&nbsp;<span>9.2</span></a> as <span id="eq-modelwithAR1"><span class="math display">\[
Y_{t} = \beta_{0} + \phi \epsilon_{t - 1} + a_{t}.
\tag{9.4}\]</span></span></p>
<p>The advantage of this representation is that the new residuals <span class="math inline">\(a_{t}\)</span> satisfy the OLS assumptions. In particular, since <span class="math inline">\(a_{t}\)</span> is white noise, <span class="math inline">\(a_{t}\)</span> is homoskedastic and uncorrelated.</p>
<p>We shall also assume that <span class="math inline">\(a_{t}\)</span> are normally distributed (for justification of the construction of confidence intervals and prediction intervals). However, even if <span class="math inline">\(a_{t}\)</span> are not normal, <span class="math inline">\(a_{t}\)</span> are uncorrelated, which is a big improvement over the serially correlated <span class="math inline">\(\epsilon_{t}\)</span>.</p>
<p>Our goal is to remove the <span class="math inline">\(\epsilon_{t}\)</span> entirely from the constant mean model and replace them with <span class="math inline">\(a_{t}\)</span> acting as new residuals. This can be done as follows. First, write <a href="#eq-constmean">Equation&nbsp;<span>9.2</span></a> for <span class="math inline">\(t-1\)</span> and multiply both sides by <span class="math inline">\(\phi\)</span>, <span id="eq-constmean1"><span class="math display">\[
\phi Y_{t -1} = \phi \beta_{0} + \phi \epsilon_{t - 1}.
\tag{9.5}\]</span></span></p>
<p>Taking the difference (<a href="#eq-modelwithAR1">Equation&nbsp;<span>9.4</span></a> minus <a href="#eq-constmean1">Equation&nbsp;<span>9.5</span></a>) eliminates <span class="math inline">\(\epsilon_{t}\)</span> from the model: <span class="math display">\[
\begin{split}
Y_{t} - \phi Y_{t - 1} &amp;= \left( \beta_{0} + \phi \epsilon_{t - 1} + a_{t} \right) - \left( \phi \beta_{0} + \phi \epsilon_{t - 1}  \right) \\
&amp;= (1 - \phi) \beta_{0} + a_{t}.
\end{split}
\]</span></p>
<p>Therefore we can rewrite the constant mean model in <a href="#eq-constmean">Equation&nbsp;<span>9.2</span></a> as <span id="eq-constmean2"><span class="math display">\[
Y_{t} = (1 - \phi) \beta_{0} + \phi Y_{t - 1} + a_{t}.
\tag{9.6}\]</span></span></p>
<p>In general, for any multiple linear regression <span id="eq-MlinModelAR1"><span class="math display">\[
Y_{t} = \beta_{0} + \sum^{k}_{j =1} \beta_{j} X_{t,j} + \epsilon_{t}, ~~  \text{where} ~~ \epsilon_{t} \sim \mbox{AR(1)},
\tag{9.7}\]</span></span> we can perform a similar procedure of eliminating <span class="math inline">\(\epsilon_{t}\)</span>.</p>
<p>This elimination procedure leads to the alternate expression <span id="eq-MlinModelAR1alt"><span class="math display">\[
Y_{t} = (1 - \phi) \beta_{0} + \phi Y_{t -1} + \sum^{k}_{j = 1} \beta_{j} (X_{t,j} - \phi X_{t-1, j}) + a_{t},
\tag{9.8}\]</span></span> where <span class="math inline">\(a_{t}\)</span> is white noise, i.e., homoskedastic with constant (zero) mean and uncorrelated. See <a href="s2_gls.html"><span>Appendix&nbsp;B</span></a> describing the method of generalized least squares and an example of <span class="math inline">\(k=1\)</span>.</p>
<p>Note that rewriting the model in this way pulls the autocorrelation parameter for the old residuals, <span class="math inline">\(\phi\)</span>, into the regression part of the model. Thus there are now <span class="math inline">\(k + 2\)</span> unknown regression parameters (<span class="math inline">\(\beta_{0}, \beta_{1}, \dots, \beta_{k}\)</span>, and <span class="math inline">\(\phi\)</span>). The introduction of an additional parameter into the regression part of the model can be regarded as the price to be paid for extracting new residuals <span class="math inline">\(a_{t}\)</span> that satisfy the OLS assumptions.</p>
<p>Note that the new residuals <span class="math inline">\(a_{t}\)</span> have smaller variance than the <span class="math inline">\(\epsilon_{t}\)</span>. In fact, <span class="math display">\[
\begin{split}
\sigma^{2} &amp; = \mbox{var} (\epsilon_{t} ) = \mbox{var} (\phi \epsilon_{t - 1} + a_{t}) \\
\\
&amp; =  \phi^{2} \mbox{var}(\epsilon_{t - 1}) + \mbox{var} (a_{t} ) ~~~ \mbox{since} ~~ \mbox{cov}(a_{t}, \epsilon_{t - 1}) = 0\\
\\
&amp; = \phi^{2}\sigma^{2}  + \nu^{2},
\end{split}
\]</span> leading to the relation <span id="eq-varresid"><span class="math display">\[
\nu^{2} = \sigma^{2} (1 - \phi^{2} ).
\tag{9.9}\]</span></span></p>
<p>However, comparing <a href="#eq-constmean2">Equation&nbsp;<span>9.6</span></a> with <a href="#eq-constmean2">Equation&nbsp;<span>9.6</span></a>, and <a href="#eq-MlinModelAR1alt">Equation&nbsp;<span>9.8</span></a> with <a href="#eq-MlinModelAR1">Equation&nbsp;<span>9.7</span></a>, we see that the rewritten form of the model is <em>not linear</em> in terms of the parameters <span class="math inline">\(\beta_{0}, \beta_{1}, \dots, \beta_{k}\)</span> and <span class="math inline">\(\phi\)</span>. For example, the intercept term <span class="math inline">\((1 - \phi) \beta_{0}\)</span> involves a product of two of the parameters. This nonlinearity makes the OLS, implemented in the R functions <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> and <code><a href="https://rdrr.io/r/stats/lsfit.html">lsfit()</a></code>, a poor method for obtaining parameter estimates. Instead, we will use the method of <em>maximum likelihood</em> (ML) carried out through such R functions as <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code>.</p>
<p>The function <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code> allows us to input the model in its original form, as in <a href="#eq-MlinModelAR1">Equation&nbsp;<span>9.7</span></a>. It then internally rewrites the model to put it in the form of <a href="#eq-MlinModelAR1alt">Equation&nbsp;<span>9.8</span></a>. (So we do not have to rewrite the model!) It then makes the assumption that the <span class="math inline">\(a_t\)</span> are normal and constructs the multivariate normal likelihood function <span class="math display">\[
L (Y_{1} , \dots , Y_{n}; Q ),
\]</span> where <span class="math inline">\(n\)</span> is the sample size and <span class="math inline">\(Q\)</span> is the vector of all unknown parameters. In general, for an AR(1) model with <span class="math inline">\(k\)</span> original predictors, we have <span class="math inline">\(Q = (\phi, \beta_{0}, \beta_{1}, \dots, \beta_{k}, \nu^{2})\)</span>. Recall that <span class="math inline">\(\nu^{2} = \mathrm{var}(a_{t}) = \mathrm{cov}(a_{t} , a_{t})\)</span>.</p>
<p>The function <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code> then uses the historical data <span class="math inline">\(Y_{1}, \dots, Y_{n}\)</span> to find the parameter estimates <span class="math display">\[
\hat{Q} = \left( \hat{\phi}, \hat{\beta}_{0} , \hat{\beta}_{1} , \dots, \hat{\beta}_{k} , \hat{\nu}^2 \right),
\]</span> which maximize the likelihood <span class="math inline">\(L\)</span>. These estimates (and other things, such as the standard errors of the estimates) can be saved to an output object in R. We will use an example to illustrate the use and interpretation of the function <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code>.</p>
<p>Moreover, we can extend the regression model in <a href="#eq-MlinModelAR1">Equation&nbsp;<span>9.7</span></a> with AR(1) errors to a model with a more general form of errors, ARMA, by assuming <span class="math inline">\(\epsilon_t \sim \text{ARMA}(p,q)\)</span> <span class="citation" data-cites="Brockwell:Davis:2002">(see Chapter 6.6 in <a href="references.html#ref-Brockwell:Davis:2002" role="doc-biblioref">Brockwell and Davis 2002</a> and <a href="references.htmlhttps://robjhyndman.com/hyndsight/arimax/" class="uri" role="doc-biblioref">https://robjhyndman.com/hyndsight/arimax/</a>)</span>: <span id="eq-MlinModelARMA"><span class="math display">\[
\begin{split}
Y_t &amp;= \sum^{k}_{j =1} \beta_{j} X_{t,j} + \epsilon_{t},\\
\epsilon_{t} &amp;= \phi_1 \epsilon_{t-1} + \dots + \phi_p \epsilon_{t-p} + \theta_1 a_{t-1} + \dots + \theta_q a_{t-q} + a_t.
\end{split}
\tag{9.10}\]</span></span> This model in <a href="#eq-MlinModelARMA">Equation&nbsp;<span>9.10</span></a> can be specified in R functions <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code>, <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code>, <code><a href="https://pkg.robjhyndman.com/forecast/reference/Arima.html">forecast::Arima()</a></code>, and <code><a href="https://pkg.robjhyndman.com/forecast/reference/auto.arima.html">forecast::auto.arima()</a></code>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The R package <code>forecast</code> has been superseded by the new package <code>fable</code> that uses an alternate parameterization of constants, see <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">?fable::ARIMA</a></code>.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember that the variables <span class="math inline">\(Y_t\)</span> and <span class="math inline">\(X_{t,j}\)</span> (<span class="math inline">\(j = 1,\dots,k\)</span>) should be detrended prior to the analysis (to avoid spurious regression results, see the previous lecture on dealing with trends in regression). If differencing is chosen as the method of detrending, the orders of differences <span class="math inline">\(d\)</span> and <span class="math inline">\(D\)</span> can be specified directly within the mentioned ARIMA functions (so R will do the differencing for us).</p>
</div>
</div>
</section><section id="arimax" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="arimax">
<span class="header-section-number">9.4</span> ARIMAX</h2>
<p>ARIMAX (‘X’ stands for ‘external regressor’) models are closely related to <a href="#eq-MlinModelARMA">Equation&nbsp;<span>9.10</span></a>, but there is an important difference. For simplicity of notation, we can present an ARMAX(<span class="math inline">\(p,q\)</span>) model that is a regular ARMA(<span class="math inline">\(p,q\)</span>) model for <span class="math inline">\(Y_t\)</span> plus the external regressors: <span id="eq-ARMAX"><span class="math display">\[
\begin{split}
Y_t &amp;= \phi_1 Y_{t-1} + \dots + \phi_p Y_{t-p} + \theta_1 a_{t-1} + \dots + \theta_q a_{t-q} + a_t\\
&amp;+\sum^{k}_{j =1} \beta_{j} X_{t,j},
\end{split}
\tag{9.11}\]</span></span> where <span class="math inline">\(a_t\)</span> is still a zero-mean white noise process. Interestingly, at this time there is no convenient way to estimate this model in R. One could <em>manually</em> write lagged values of <span class="math inline">\(Y_t\)</span> as external regressors (i.e., create new variables in R for <span class="math inline">\(Y_{t-1},\dots, Y_{t-p}\)</span>), use these variables in the R functions mentioned above, but force <span class="math inline">\(p=0\)</span> <span class="citation" data-cites="Soliman:etal:2019:influenza">(e.g., <a href="references.html#ref-Soliman:etal:2019:influenza" role="doc-biblioref">Soliman et al. 2019</a> used the functions from the R package <code>forecast</code>)</span>.</p>
<p>The difference between <a href="#eq-MlinModelARMA">Equation&nbsp;<span>9.10</span></a> and <a href="#eq-ARMAX">Equation&nbsp;<span>9.11</span></a> is the presence of lagged values of the response variable, <span class="math inline">\(Y_t\)</span>, in <a href="#eq-ARMAX">Equation&nbsp;<span>9.11</span></a>. As Hyndman points out, regression coefficients <span class="math inline">\(\beta_j\)</span> in <a href="#eq-ARMAX">Equation&nbsp;<span>9.11</span></a> lose their interpretability compared with usual regression and do not show the effect on <span class="math inline">\(Y_t\)</span> when <span class="math inline">\(X_t\)</span> increased by one. Instead, <span class="math inline">\(\beta\)</span>’s in ARMAX <a href="#eq-ARMAX">Equation&nbsp;<span>9.11</span></a> are interpreted <em>conditional</em> on the value of previous values of the response variable (<a href="https://robjhyndman.com/hyndsight/arimax/" class="uri">https://robjhyndman.com/hyndsight/arimax/</a>). Therefore, model formulation as in <a href="#eq-MlinModelARMA">Equation&nbsp;<span>9.10</span></a> may be preferred.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Other applicable models include models with mixed effects such as for <em>repeated measures ANOVA</em> (e.g., implemented in R using <code><a href="https://rdrr.io/pkg/nlme/man/gls.html">nlme::gls()</a></code> and <code><a href="https://rdrr.io/pkg/nlme/man/lme.html">nlme::lme()</a></code>, see different correlation structures; without a grouping factor, the results of <code>nlme::lme(..., correlation = corARMA(...))</code> should be similar to estimating model in <a href="#eq-MlinModelARMA">Equation&nbsp;<span>9.10</span></a>). Other regression functions often borrow the functionality (and syntax) of the package <code>nlme</code> for estimating random effects, so autocorrelated residuals can be incorporated into a <em>generalized additive model</em>, GAM, <code><a href="https://rdrr.io/pkg/mgcv/man/gamm.html">mgcv::gamm()</a></code>; <em>generalized additive model for location scale and shape</em>, GAMLSS, <code><a href="https://rdrr.io/pkg/gamlss/man/gamlss.html">gamlss::gamlss()</a></code>, which also can be used just as GAM, if scale and shape parameters are not modeled. A slightly different solution is possible using a <em>generalized autoregressive moving average model</em> (GARMA) demonstrated in <a href="#sec-GARMA"><span>Section&nbsp;9.5</span></a>, see <code><a href="https://rdrr.io/pkg/gamlss.util/man/garmaFit.html">gamlss.util::garmaFit()</a></code>.</p>
</div>
</div>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Example: Golden tilefish ARIMAX
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we have time series of 1918–2017 annual landings of golden tilefish (tonne) in the U.S. North Atlantic region and the Atlantic Multi-decadal Oscillation (AMO) index characterizing climatic conditions (<a href="#fig-tilefishTS">Figure&nbsp;<span>9.4</span></a>). These time series were described in <span class="citation" data-cites="Nesslage:etal:2021:environmental">Nesslage et al. (<a href="references.html#ref-Nesslage:etal:2021:environmental" role="doc-biblioref">2021</a>)</span> with R code by <span class="citation" data-cites="lyubchich3732840">Lyubchich and Nesslage (<a href="references.html#ref-lyubchich3732840" role="doc-biblioref">2020</a>)</span>. The goal is to develop a regression model to explore the relationship between the landings and AMO.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/tilefish.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt;       Year         Landings         AMO        
#&gt;  Min.   :1918   Min.   :   5   Min.   :-0.434  
#&gt;  1st Qu.:1943   1st Qu.: 454   1st Qu.:-0.148  
#&gt;  Median :1968   Median : 749   Median : 0.014  
#&gt;  Mean   :1968   Mean   : 952   Mean   : 0.001  
#&gt;  3rd Qu.:1992   3rd Qu.:1204   3rd Qu.: 0.149  
#&gt;  Max.   :2017   Max.   :3968   Max.   : 0.358  
#&gt;                 NA's   :3</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">D</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Landings</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Landings (tonne)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">D</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">AMO</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"AMO"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tilefishTS" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-tilefishTS-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.4: Time series plots of the golden tilefish landings and AMO.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Interpolation of missing data (a.k.a. imputation) is a separate and very expansive topic. For a univariate time series, linear interpolation can be implemented using <code><a href="https://pkg.robjhyndman.com/forecast/reference/na.interp.html">forecast::na.interp()</a></code>. Also, the landings time series required a power transformation, so the square root transformation was applied (<a href="#fig-tilefishScatter">Figure&nbsp;<span>9.5</span></a>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>Landings_noNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/na.interp.html">na.interp</a></span><span class="op">(</span><span class="va">D</span><span class="op">$</span><span class="va">Landings</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>Landings_noNA_sqrt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">Landings_noNA</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">D</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">AMO</span>, <span class="va">Landings_noNA_sqrt</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html">ggpairs</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tilefishScatter" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-tilefishScatter-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.5: Scatterplot matrix of landings and AMO.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>, mgp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">D</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/acf.html">ccf</a></span><span class="op">(</span><span class="va">AMO</span>, <span class="va">Landings_noNA_sqrt</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-tilefishCCF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-tilefishCCF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.6: Estimated cross-correlation function (CCF) of time series of the landings and AMO.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Based on the strongest lagged correlations (<a href="#fig-tilefishCCF">Figure&nbsp;<span>9.6</span></a>), implement a model <span class="math display">\[
\sqrt{Landings_t} = \beta_0 + \beta_{1} AMO_{t-7} + \epsilon_{t},
\]</span> where <span class="math inline">\(\epsilon_{t} \sim\)</span> ARMA(<span class="math inline">\(p,q\)</span>), and the orders <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are selected automatically based on Akaike information criterion.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fable.tidyverts.org">fable</a></span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">Year</span>, <span class="va">Landings_noNA_sqrt</span>, <span class="va">AMO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://fabletools.tidyverts.org/reference/model.html">model</a></span><span class="op">(</span><span class="fu"><a href="https://fable.tidyverts.org/reference/ARIMA.html">ARIMA</a></span><span class="op">(</span><span class="va">Landings_noNA_sqrt</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">AMO</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://fabletools.tidyverts.org/reference/report.html">report</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; Series: Landings_noNA_sqrt 
#&gt; Model: LM w/ ARIMA(2,0,0) errors 
#&gt; 
#&gt; Coefficients:
#&gt;         ar1     ar2  dplyr::lag(AMO, 7)  intercept
#&gt;       0.991  -0.184               -6.30       28.3
#&gt; s.e.  0.104   0.102                5.02        3.4
#&gt; 
#&gt; sigma^2 estimated as 41.61:  log likelihood=-307
#&gt; AIC=625   AICc=626   BIC=638</code></pre>
</div>
</div>
<p>We forgot to check the stationarity of the time series! It seems that the landings can be considered as a unit-root process, so differencing is needed, hence a modified model is</p>
<p><span class="math display">\[
\Delta \sqrt{Landings_t} = \beta_0 + \beta_{1} AMO_{t-7} + \epsilon_{t}.
\]</span></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/auto.arima.html">auto.arima</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">D</span><span class="op">$</span><span class="va">Landings_noNA_sqrt</span><span class="op">)</span>,</span>
<span>                 xreg <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">D</span><span class="op">$</span><span class="va">AMO</span>, <span class="fl">7</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                 allowmean <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; Series: diff(D$Landings_noNA_sqrt) 
#&gt; Regression with ARIMA(0,0,0) errors 
#&gt; 
#&gt; Coefficients:
#&gt;        xreg
#&gt;       -2.58
#&gt; s.e.   3.82
#&gt; 
#&gt; sigma^2 = 46.3:  log likelihood = -313
#&gt; AIC=629   AICc=630   BIC=634</code></pre>
</div>
</div>
<p>Note it is different from the implementation with <code>d = 1</code>, which differences all the series.</p>
<p><span class="math display">\[
\Delta \sqrt{Landings_t} = \beta_0 + \beta_{1} \Delta AMO_{t-7} + \epsilon_{t}
\]</span></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/auto.arima.html">auto.arima</a></span><span class="op">(</span><span class="va">D</span><span class="op">$</span><span class="va">Landings_noNA_sqrt</span>,</span>
<span>                     xreg <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">D</span><span class="op">$</span><span class="va">AMO</span>, <span class="fl">7</span><span class="op">)</span>, </span>
<span>                     d <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; Series: D$Landings_noNA_sqrt 
#&gt; Regression with ARIMA(0,1,0) errors 
#&gt; 
#&gt; Coefficients:
#&gt;        xreg
#&gt;       -5.37
#&gt; s.e.   5.14
#&gt; 
#&gt; sigma^2 = 45.7:  log likelihood = -309
#&gt; AIC=623   AICc=623   BIC=628</code></pre>
</div>
</div>
<p>Similarly, using the newer package <code>fable</code>.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">Year</span>, <span class="va">Landings_noNA_sqrt</span>, <span class="va">AMO</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://fabletools.tidyverts.org/reference/model.html">model</a></span><span class="op">(</span><span class="fu"><a href="https://fable.tidyverts.org/reference/ARIMA.html">ARIMA</a></span><span class="op">(</span><span class="va">Landings_noNA_sqrt</span> <span class="op">~</span> <span class="fu">pdq</span><span class="op">(</span>d <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">AMO</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://fabletools.tidyverts.org/reference/report.html">report</a></span><span class="op">(</span><span class="va">m3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; Series: Landings_noNA_sqrt 
#&gt; Model: LM w/ ARIMA(0,1,0) errors 
#&gt; 
#&gt; Coefficients:
#&gt;       dplyr::lag(AMO, 7)
#&gt;                    -5.37
#&gt; s.e.                5.14
#&gt; 
#&gt; sigma^2 estimated as 45.73:  log likelihood=-309
#&gt; AIC=623   AICc=623   BIC=628</code></pre>
</div>
</div>
</div>
</div>
</section><section id="sec-GARMA" class="level2" data-number="9.5"><h2 data-number="9.5" class="anchored" data-anchor-id="sec-GARMA">
<span class="header-section-number">9.5</span> GARMA</h2>
<p>Let <span class="math inline">\(Y_t\)</span> be the observed time series and <span class="math inline">\(\boldsymbol{X_t}\)</span> exogenous regressors. Then, we can model the conditional distribution of <span class="math inline">\(Y_t\)</span>, given <span class="math inline">\(Y_1,\dots,Y_{t-1}\)</span>, <span class="math inline">\(\boldsymbol{X_1,\dots,X_{t}}\)</span> as <span id="eq-GARMA"><span class="math display">\[
g(\mu_t)=\boldsymbol{X}'_t\beta+\sum_{j=1}^p\phi_j\{g(Y_{t-j})- \boldsymbol{X}'_{t-j}\beta\}
+\sum_{j=1}^q\theta_j \{g(Y_{t-j})-g(\mu_{t-j})\},
\tag{9.12}\]</span></span> where <span class="math inline">\(g(\cdot)\)</span> is an appropriate link function; <span class="math inline">\(\mu_t\)</span> is a conditional mean of the dependent variable; <span class="math inline">\(\boldsymbol{\beta}\)</span> is a vector of regression coefficients; <span class="math inline">\(\phi_j\)</span>, <span class="math inline">\(j=1,\dots, p\)</span>, are the autoregressive coefficients; <span class="math inline">\(\theta_j\)</span>, <span class="math inline">\(j=1,\dots,q\)</span>, are the moving average coefficients, while <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are the autoregressive and moving average orders, respectively.</p>
<p>In certain cases, the function <span class="math inline">\(g(\cdot)\)</span> requires some transformation of the original series <span class="math inline">\(Y_{t-j}\)</span> to avoid the non-existence of <span class="math inline">\(g(Y_{t-j})\)</span> <span class="citation" data-cites="Benjamin:etal:2003">(<a href="references.html#ref-Benjamin:etal:2003" role="doc-biblioref">Benjamin et al. 2003</a>)</span>.</p>
<p>The generalized autoregressive moving average model (<a href="#eq-GARMA">Equation&nbsp;<span>9.12</span></a>), GARMA(<span class="math inline">\(p,q\)</span>), represents a flexible observation-driven modification of the classical Box–Jenkins methodology and GLMs for integer-valued time series. GARMA further advances the classical Gaussian ARMA model to a case where the distribution of the dependent variable is not only non-Gaussian but can be discrete. The dependent variable is assumed to belong to a conditional exponential family distribution given the past information of the process and thus the GARMA can be used to model a variety of discrete distributions <span class="citation" data-cites="Benjamin:etal:2003">(<a href="references.html#ref-Benjamin:etal:2003" role="doc-biblioref">Benjamin et al. 2003</a>)</span>. The GARMA model also extends the work of <span class="citation" data-cites="Zeger:Qaqish:1988">Zeger and Qaqish (<a href="references.html#ref-Zeger:Qaqish:1988" role="doc-biblioref">1988</a>)</span>, who proposed an autoregressive exponential family model, and <span class="citation" data-cites="Li:1994">Li (<a href="references.html#ref-Li:1994" role="doc-biblioref">1994</a>)</span>, who introduced its moving average counterpart.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Example: Insurance claims GARMA model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider the weekly number of house insurance claims related to water and weather damage in one Canadian city. The number is standardized by the daily number of insured properties in that city. Explore the relationship between the number of claims and weekly total precipitation (mm).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Insurance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/insurance_weekly.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Claims</span>, <span class="va">Precipitation</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">Insurance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt;      Claims      Precipitation 
#&gt;  Min.   :  0.0   Min.   : 0.0  
#&gt;  1st Qu.:  1.0   1st Qu.: 0.8  
#&gt;  Median :  3.0   Median : 3.8  
#&gt;  Mean   :  3.6   Mean   : 7.7  
#&gt;  3rd Qu.:  4.0   3rd Qu.:10.0  
#&gt;  Max.   :170.0   Max.   :77.3</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Insurance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html">ggpairs</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-insScatter" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-insScatter-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.7: Scatterplot matrix of weekly weather-related home insurance outcomes and precipitation.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Based on the distribution plots in <a href="#fig-insScatter">Figure&nbsp;<span>9.7</span></a>, the data are highly right-skewed (have heavy right tails). The number of claims is also a discrete variable. Therefore, we deal with non-normal distributions and need to use generalized-type models, like the generalized linear or additive models (GLMs or GAMs). Since there are many zeros in the counts of claims, we can start with the zero-adjusted Poisson distribution to model the number of claims <span class="citation" data-cites="Stasinopoulos:Rigby:2007 Gupta:etal:1996">(<a href="references.html#ref-Gupta:etal:1996" role="doc-biblioref">Gupta et al. 1996</a>; <a href="references.html#ref-Stasinopoulos:Rigby:2007" role="doc-biblioref">Stasinopoulos and Rigby 2007</a>)</span>.</p>
<p>In our case, there is just a slight chance that past-week precipitation affects the current-week insurance claims. Hence, we will still keep the current precipitation and additionally explore the lagged effects, using the cross-correlation function (<a href="#fig-insCCF">Figure&nbsp;<span>9.8</span></a>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>, mgp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">logconstant</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">Insurance</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/acf.html">ccf</a></span><span class="op">(</span><span class="va">Precipitation</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">+</span> <span class="va">logconstant</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span>, lag.max <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-insCCF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-insCCF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.8: Estimated cross-correlation function (CCF) of time series of the number of home insurance claims and precipitation.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Based on the estimated CCFs (<a href="#fig-insCCF">Figure&nbsp;<span>9.8</span></a>), past-week precipitation is significantly correlated with the current-week number of claims, so we can add the lagged predictor into our models.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Insurance</span> <span class="op">&lt;-</span> <span class="va">Insurance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>Precipitation_lag1 <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Precipitation</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>           Week <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Insurance</span><span class="op">)</span>,</span>
<span>           Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span>, each <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>,</span>
<span>           Claims_ln <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">+</span> <span class="va">logconstant</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Based on <a href="#fig-insACF">Figure&nbsp;<span>9.9</span></a>, there might be an increasing trend in the number of claims that we might be able to approximate with a linear function.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html">as.ts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Insurance</span><span class="op">$</span><span class="va">Claims</span> <span class="op">+</span> <span class="va">logconstant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Week"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"ln(Number of claims)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html">as.ts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Insurance</span><span class="op">$</span><span class="va">Claims</span> <span class="op">+</span> <span class="va">logconstant</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      lag.max <span class="op">=</span> <span class="fl">110</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-insACF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-insACF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.9: Time series plot and sample ACF of the weekly number of claims in a city, after the ln transformation.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Plot the data once again after the transformations (<a href="#fig-insScatter2">Figure&nbsp;<span>9.10</span></a>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Insurance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Claims</span>, <span class="op">-</span><span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html">ggpairs</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-insScatter2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-insScatter2-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.10: Scatterplot matrix of the weekly number of weather-related home insurance claims and precipitation.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Fit a GARMA model relating the weekly number of insurance claims to the total precipitation during that and previous weeks.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># The model function doesn't accept NAs, so remove them</span></span>
<span><span class="va">Insurance_noNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">Insurance</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.gamlss.org/">gamlss.util</a></span><span class="op">)</span></span>
<span><span class="va">m00zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss.util/man/garmaFit.html">garmaFit</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="va">Precipitation</span> <span class="op">+</span> <span class="va">Week</span> <span class="op">+</span> <span class="va">Precipitation_lag1</span></span>
<span>                   ,family <span class="op">=</span> <span class="va">ZIP</span></span>
<span>                   ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; deviance of linear model=  3014</code></pre>
</div>
</div>
<p>Obtain ACF and PACF plots of the model residuals to select ARMA order (<a href="#fig-insresACF00">Figure&nbsp;<span>9.11</span></a>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m00zip</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m00zip</span><span class="op">$</span><span class="va">residuals</span>, type <span class="op">=</span> <span class="st">"partial"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-insresACF00" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-insresACF00-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.11: ACF and PACF plots of residuals of the base model GARMA(0,0) based on ZIP distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Based on the observed ACF and PACF patterns in <a href="#fig-insresACF00">Figure&nbsp;<span>9.11</span></a>, an appropriate model for the temporal dependence could be ARMA(3,0). Refit the GARMA model specifying these orders. Then verify that the temporal dependence in residuals was removed (<a href="#fig-m03zipACF">Figure&nbsp;<span>9.12</span></a>), and assess other assumptions (<a href="#fig-m03zip">Figure&nbsp;<span>9.13</span></a>), including homogeneity and normality of the quantile residuals.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">m30zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss.util/man/garmaFit.html">garmaFit</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="va">Precipitation</span> <span class="op">+</span> <span class="va">Week</span> <span class="op">+</span> <span class="va">Precipitation_lag1</span></span>
<span>                ,order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>                ,family <span class="op">=</span> <span class="va">ZIP</span></span>
<span>                ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; deviance of linear model=  3014 
#&gt; deviance of  garma model=  2926</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m30zip</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family:  c("ZIP", "Poisson Zero Inflated") 
#&gt; Fitting method: "nlminb" 
#&gt; 
#&gt; Call:  garmaFit(formula = Claims ~ Precipitation + Week + Precipitation_lag1,  
#&gt;     order = c(3, 0), data = Insurance_noNA, family = ZIP) 
#&gt; 
#&gt; 
#&gt; Coefficient(s):
#&gt;                            Estimate  Std. Error  t value   Pr(&gt;|t|)    
#&gt; beta.(Intercept)        0.848144482 0.208730902  4.06334 4.8376e-05 ***
#&gt; beta.Precipitation      0.033050327 0.001415750 23.34475 &lt; 2.22e-16 ***
#&gt; beta.Week               0.000915048 0.000607178  1.50705  0.1317975    
#&gt; beta.Precipitation_lag1 0.017806845 0.001834035  9.70911 &lt; 2.22e-16 ***
#&gt; phi1                    0.308599336 0.027913881 11.05541 &lt; 2.22e-16 ***
#&gt; phi2                    0.038617209 0.024183455  1.59684  0.1103005    
#&gt; phi3                    0.304474331 0.029638021 10.27310 &lt; 2.22e-16 ***
#&gt; sigma                   0.074047092 0.021057484  3.51643  0.0004374 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt;  Degrees of Freedom for the fit: 8 Residual Deg. of Freedom   511 
#&gt; Global Deviance:     2926 
#&gt;             AIC:     2942 
#&gt;             SBC:     2976</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m30zip</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m30zip</span><span class="op">$</span><span class="va">residuals</span>, type <span class="op">=</span> <span class="st">"partial"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-m03zipACF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m03zipACF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.12: ACF and PACF plots of the GARMA(0,3) model residuals based on ZIP distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m30zip</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; ******************************************************************
#&gt;   Summary of the Randomised Quantile Residuals
#&gt;                            mean   =  0.257 
#&gt;                        variance   =  1.98 
#&gt;                coef. of skewness  =  1.23 
#&gt;                coef. of kurtosis  =  6.76 
#&gt; Filliben correlation coefficient  =  0.967 
#&gt; ******************************************************************</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-m03zip" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m03zip-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.13: Default diagnostics of the GARMA(0,3) model residuals based on ZIP distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>See <span class="citation" data-cites="Dunn:Smyth:1996">Dunn and Smyth (<a href="references.html#ref-Dunn:Smyth:1996" role="doc-biblioref">1996</a>)</span> for the details on randomized quantile residuals. Overall, their poor correspondence with the standard normal distribution shows a lack of fit of the model. See <code><a href="https://rdrr.io/pkg/gamlss.dist/man/gamlss.family.html">?gamlss.family</a></code> for other distribution families, continuous and discrete; somewhat out-of-date tables with many of these distributions listed are available from <span class="citation" data-cites="Stasinopoulos:Rigby:2007">Stasinopoulos and Rigby (<a href="references.html#ref-Stasinopoulos:Rigby:2007" role="doc-biblioref">2007</a>)</span>.</p>
<p>Here we try one other distribution appropriate for modeling overdispersed count data – negative binomial distribution. See the model summary below and the verification of residuals in <a href="#fig-m03nbiACF">Figure&nbsp;<span>9.14</span></a> and <a href="#fig-m03nbi">Figure&nbsp;<span>9.15</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">m03nbi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss.util/man/garmaFit.html">garmaFit</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="va">Precipitation</span> <span class="op">+</span> <span class="va">Week</span> <span class="op">+</span> <span class="va">Precipitation_lag1</span></span>
<span>                ,order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>                ,family <span class="op">=</span> <span class="va">NBI</span></span>
<span>                ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; deviance of linear model=  2324 
#&gt; deviance of  garma model=  2320</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m03nbi</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family:  c("NBI", "Negative Binomial type I") 
#&gt; Fitting method: "nlminb" 
#&gt; 
#&gt; Call:  garmaFit(formula = Claims ~ Precipitation + Week + Precipitation_lag1,  
#&gt;     order = c(0, 3), data = Insurance_noNA, family = NBI) 
#&gt; 
#&gt; 
#&gt; Coefficient(s):
#&gt;                             Estimate   Std. Error  t value   Pr(&gt;|t|)    
#&gt; beta.(Intercept)         0.572171010  0.105838165  5.40609 6.4414e-08 ***
#&gt; beta.Precipitation       0.030544133  0.003048269 10.02016 &lt; 2.22e-16 ***
#&gt; beta.Week                0.001447954  0.000293054  4.94092 7.7755e-07 ***
#&gt; beta.Precipitation_lag1  0.003857115  0.003396527  1.13561 0.25612163    
#&gt; theta1                   0.107102854  0.036155734  2.96226 0.00305385 ** 
#&gt; theta2                   0.115018618  0.030764826  3.73864 0.00018502 ***
#&gt; theta3                  -0.064511562  0.031249621 -2.06440 0.03898028 *  
#&gt; sigma                    0.347744482  0.037636402  9.23958 &lt; 2.22e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt;  Degrees of Freedom for the fit: 8 Residual Deg. of Freedom   511 
#&gt; Global Deviance:     2320 
#&gt;             AIC:     2336 
#&gt;             SBC:     2370</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m03nbi</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m03nbi</span><span class="op">$</span><span class="va">residuals</span>, type <span class="op">=</span> <span class="st">"partial"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (weeks)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-m03nbiACF" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m03nbiACF-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.14: ACF and PACF plots of the GARMA(0,3) model residuals based on NBI distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m03nbi</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; ******************************************************************
#&gt;   Summary of the Randomised Quantile Residuals
#&gt;                            mean   =  0.0133 
#&gt;                        variance   =  1.06 
#&gt;                coef. of skewness  =  0.682 
#&gt;                coef. of kurtosis  =  7.24 
#&gt; Filliben correlation coefficient  =  0.979 
#&gt; ******************************************************************</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-m03nbi" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m03nbi-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.15: Default diagnostics of the GARMA(0,3) model residuals based on NBI distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The residual diagnostics look better for the latter model. One could also consider modeling the strictly periodical component such as using the Fourier series, however, <a href="#fig-insACF">Figure&nbsp;<span>9.9</span></a> did not show a prominent seasonality.</p>
</div>
</div>
</section><section id="sec-GAMLSS" class="level2" data-number="9.6"><h2 data-number="9.6" class="anchored" data-anchor-id="sec-GAMLSS">
<span class="header-section-number">9.6</span> GAMLSS</h2>
<p><span class="citation" data-cites="Stasinopoulos:Rigby:2007">Stasinopoulos and Rigby (<a href="references.html#ref-Stasinopoulos:Rigby:2007" role="doc-biblioref">2007</a>)</span> provide an extension of a generalized additive model to <span class="math inline">\(k=1,2,3,4\)</span> parameters <span class="math inline">\(\boldsymbol{\theta}_k\)</span> of a distribution in a so-called <em>generalized additive model for location scale and shape</em> (GAMLSS). The <span class="math inline">\(k\)</span> parameters represent the location parameter <span class="math inline">\(\mu\)</span> (it is what we typically model with regression models), scale <span class="math inline">\(\sigma\)</span>, and two shape parameters: skewness and kurtosis. The model can be further generalized for <span class="math inline">\(k&gt;4\)</span> if needed. It allows us to fit <span class="math inline">\(k\)</span> individual models to study relationships between regressors <span class="math inline">\(\boldsymbol{x}\)</span> and parameters of the response distribution: <span id="eq-GAMLSS"><span class="math display">\[
g_k(\boldsymbol{\theta}_k) = h_k\left(\boldsymbol{X}_k,\boldsymbol{\beta}_k\right) + \sum_{j=1}^{J_k}h_{jk}(\boldsymbol{x}_{jk}),
\tag{9.13}\]</span></span> where <span class="math inline">\(k=1\)</span> produces model for the mean; <span class="math inline">\(h_k(\cdot)\)</span> and <span class="math inline">\(h_{jk}(\cdot)\)</span> are nonlinear functions; <span class="math inline">\(\boldsymbol{\beta}_k\)</span> is a parameter vector of length <span class="math inline">\(J_k\)</span>; <span class="math inline">\(\boldsymbol{X}_k\)</span> is an <span class="math inline">\(n\times J_k\)</span> design matrix; <span class="math inline">\(\boldsymbol{x}_{jk}\)</span> are vectors of length <span class="math inline">\(n\)</span>. The terms in the GAMLSS provide a flexible framework to specify nonlinearities, random effects, and correlation structure as in the mixed effects models <span class="citation" data-cites="Zuur:etal:2009">(<a href="references.html#ref-Zuur:etal:2009" role="doc-biblioref">Zuur et al. 2009</a>)</span>; see Table 3 by <span class="citation" data-cites="Stasinopoulos:Rigby:2007">Stasinopoulos and Rigby (<a href="references.html#ref-Stasinopoulos:Rigby:2007" role="doc-biblioref">2007</a>)</span> for the possible specifications of the additive terms. Hence, a model of the form <a href="#eq-GAMLSS">Equation&nbsp;<span>9.13</span></a> may accommodate non-normal distributions, possibly nonlinear relationships, and spatiotemporal dependencies in the data.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Example: Insurance claims GAMLSS
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we use insights from the latest GARMA model and specify the same regressors and distribution family of the response variable in a GAMLSS.</p>
<p>Negative binomial distribution has two parameters (see <code><a href="https://rdrr.io/pkg/gamlss.dist/man/NBI.html">?NBI</a></code>) – location and scale – so the GAMLSS using this distribution family can include up to two equations (<span class="math inline">\(k = 1, 2\)</span> in <a href="#eq-GAMLSS">Equation&nbsp;<span>9.13</span></a>).</p>
<p>We will keep a linear relationship between claims and the week number (parametric linear trend; note that the variable <code>Week</code> here is the time index, not the week of the year) but will use nonparametric additive smooths for the relationships between number of claims and precipitation amounts.</p>
<p>We will model the scale (variability) of the number of claims using a smooth term of the week number.</p>
<p>We start by fitting a model as follows: <span id="eq-GAMLSSins"><span class="math display">\[
\begin{split}
Claims_t &amp;= NegBin(\mu_t, \sigma_t) \\
\ln(\mu_t) &amp;= a_0 + a_1 Week_t + f_1(Precipitation_t) + f_2(Precipitation_{t-1}) + \epsilon_t \\
\ln(\sigma_t) &amp;= b_0 + f_3(Week) \\
\end{split}
\tag{9.14}\]</span></span> where <span class="math inline">\(\epsilon_t \sim \mathrm{WN}(0,\sigma^2)\)</span>; <span class="math inline">\(a_0\)</span>, <span class="math inline">\(a_1\)</span>, and <span class="math inline">\(b_0\)</span> are parametric coefficients; <span class="math inline">\(f_1\)</span>, <span class="math inline">\(f_2\)</span>, and <span class="math inline">\(f_3\)</span> are nonparametric smooths.</p>
<p>In its expandable collection of smoothers, the R package <code>gamlss</code> features penalized B-splines. See the help files <code><a href="https://rdrr.io/pkg/gamlss/man/gamlss.html">?gamlss</a></code> and <code><a href="https://rdrr.io/pkg/gamlss/man/ps.html">?pb</a></code> for more details and the review of spline functions in R by <span class="citation" data-cites="Perperoglou:etal:2019">Perperoglou et al. (<a href="references.html#ref-Perperoglou:etal:2019" role="doc-biblioref">2019</a>)</span>. However, we used the original P-splines <code><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps()</a></code> because they provided more visually smooth results than <code><a href="https://rdrr.io/pkg/gamlss/man/ps.html">pb()</a></code> under the default settings. Note that the model summary below has a table for each parameter of the distribution. The obtained term plots are in <a href="#fig-m00gamlssTermsMu">Figure&nbsp;<span>9.16</span></a> and <a href="#fig-m00gamlssTermsSigma">Figure&nbsp;<span>9.17</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.gamlss.com/">gamlss</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">m00_gamlss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/gamlss.html">gamlss</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Precipitation</span><span class="op">)</span> <span class="op">+</span> <span class="va">Week</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Precipitation_lag1</span><span class="op">)</span></span>
<span>                     ,sigma.formula <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Week</span><span class="op">)</span></span>
<span>                     ,family <span class="op">=</span> <span class="va">NBI</span></span>
<span>                     ,control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/gamlss.control.html">gamlss.control</a></span><span class="op">(</span>c.crit <span class="op">=</span> <span class="fl">0.01</span>, trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                     ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m00_gamlss</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; ******************************************************************
#&gt; Family:  c("NBI", "Negative Binomial type I") 
#&gt; 
#&gt; Call:  gamlss(formula = Claims ~ ps(Precipitation) + Week +  
#&gt;     ps(Precipitation_lag1), sigma.formula = ~ps(Week),  
#&gt;     family = NBI, data = Insurance_noNA, control = gamlss.control(c.crit = 0.01,  
#&gt;         trace = FALSE)) 
#&gt; 
#&gt; Fitting method: RS() 
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; Mu link function:  log
#&gt; Mu Coefficients:
#&gt;                        Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)            0.572497   0.092566    6.18  1.3e-09 ***
#&gt; ps(Precipitation)      0.014442   0.002691    5.37  1.2e-07 ***
#&gt; Week                   0.001520   0.000269    5.64  2.8e-08 ***
#&gt; ps(Precipitation_lag1) 0.011326   0.002908    3.90  0.00011 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; Sigma link function:  log
#&gt; Sigma Coefficients:
#&gt;              Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) -0.371642   0.218617   -1.70  0.08975 .  
#&gt; ps(Week)    -0.002379   0.000717   -3.32  0.00098 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; NOTE: Additive smoothing terms exist in the formulas: 
#&gt;  i) Std. Error for smoothers are for the linear effect only. 
#&gt; ii) Std. Error for the linear terms maybe are not accurate. 
#&gt; ------------------------------------------------------------------
#&gt; No. of observations in the fit:  519 
#&gt; Degrees of Freedom for the fit:  15
#&gt;       Residual Deg. of Freedom:  504 
#&gt;                       at cycle:  6 
#&gt;  
#&gt; Global Deviance:     2214 
#&gt;             AIC:     2244 
#&gt;             SBC:     2308 
#&gt; ******************************************************************</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">gamlss.ggplots</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss.ggplots/man/fitted_terms.html">fitted_terms</a></span><span class="op">(</span><span class="va">m00_gamlss</span>, rug <span class="op">=</span> <span class="cn">TRUE</span>, nrow <span class="op">=</span> <span class="fl">1</span>, what <span class="op">=</span> <span class="st">"mu"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-m00gamlssTermsMu" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m00gamlssTermsMu-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.16: GAMLSS terms showing the estimated relationships between the regressors and the <em>location</em> parameter for the distribution of the number of home insurance claims.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">gamlss.ggplots</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss.ggplots/man/fitted_terms.html">fitted_terms</a></span><span class="op">(</span><span class="va">m00_gamlss</span>, rug <span class="op">=</span> <span class="cn">TRUE</span>, nrow <span class="op">=</span> <span class="fl">1</span>, what <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-m00gamlssTermsSigma" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m00gamlssTermsSigma-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.17: GAMLSS terms showing the estimated relationships between the regressors and the <em>scale</em> parameter for the distribution of the number of home insurance claims.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>For the correlation estimates to work, we need to specify a grouping factor for the random effects. To create a grouping factor, we added a variable with the city ID; here it has only one level <code>"City A"</code> and hence does not affect the estimates substantially. If we had information from multiple cities, the specified form of autoregressive structure <code>form = ~Week|City</code> could readily accommodate it.</p>
<p>The code below estimates the model from <a href="#eq-GAMLSSins">Equation&nbsp;<span>9.14</span></a> again but assumes the new autocorrelation structure in the residuals: <span class="math inline">\(\epsilon_t \sim\)</span> ARMA(0,3). The control arguments change the default settings to speed up the algorithm convergence. See the model summary below and the verification of residuals in <a href="#fig-m03gamlssRES">Figure&nbsp;<span>9.18</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">Insurance_noNA</span><span class="op">$</span><span class="va">City</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="st">"City A"</span><span class="op">)</span></span>
<span><span class="va">m03_gamlss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/gamlss.html">gamlss</a></span><span class="op">(</span><span class="va">Claims</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/random.html">re</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Precipitation</span><span class="op">)</span> <span class="op">+</span> <span class="va">Week</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Precipitation_lag1</span><span class="op">)</span></span>
<span>                                 ,random <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">|</span><span class="va">City</span></span>
<span>                                 ,correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corARMA.html">corARMA</a></span><span class="op">(</span>form <span class="op">=</span> <span class="op">~</span><span class="va">Week</span><span class="op">|</span><span class="va">City</span>, q <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>                                 ,method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span>
<span>                     ,sigma.formula <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/ps.html">ps</a></span><span class="op">(</span><span class="va">Week</span><span class="op">)</span></span>
<span>                     ,family <span class="op">=</span> <span class="va">NBI</span></span>
<span>                     ,i.control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/glim.control.html">glim.control</a></span><span class="op">(</span>cc <span class="op">=</span> <span class="fl">0.01</span>, bf.cyc <span class="op">=</span> <span class="fl">100</span>, bf.tol <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>                     ,control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/gamlss.control.html">gamlss.control</a></span><span class="op">(</span>c.crit <span class="op">=</span> <span class="fl">0.01</span>, trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                     ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<p>Model summary for the location parameter:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/gamlss/man/getSmo.html">getSmo</a></span><span class="op">(</span><span class="va">m03_gamlss</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: Data 
#&gt;    AIC  BIC logLik
#&gt;   1521 1559   -751
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~1 | City
#&gt;         (Intercept) Residual
#&gt; StdDev:       0.147     1.26
#&gt; 
#&gt; Correlation Structure: ARMA(0,3)
#&gt;  Formula: ~Week | City 
#&gt;  Parameter estimate(s):
#&gt; Theta1 Theta2 Theta3 
#&gt; 0.1946 0.0437 0.0332 
#&gt; Variance function:
#&gt;  Structure: fixed weights
#&gt;  Formula: ~W.var 
#&gt; Fixed effects:  list(fix.formula) 
#&gt;                         Value Std.Error  DF t-value p-value
#&gt; (Intercept)            -0.568    0.2051 515   -2.77  0.0058
#&gt; ps(Precipitation)       0.018    0.0033 515    5.49  0.0000
#&gt; Week                    0.001    0.0004 515    3.36  0.0008
#&gt; ps(Precipitation_lag1)  0.009    0.0036 515    2.64  0.0086
#&gt;  Correlation: 
#&gt;                        (Intr) ps(Pr) Week  
#&gt; ps(Precipitation)      -0.145              
#&gt; Week                   -0.616 -0.010       
#&gt; ps(Precipitation_lag1) -0.135  0.017 -0.022
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;    Min     Q1    Med     Q3    Max 
#&gt; -1.384 -0.549 -0.155  0.327 14.056 
#&gt; 
#&gt; Number of Observations: 519
#&gt; Number of Groups: 1</code></pre>
</div>
</div>
<p>Model summary for all distribution parameters:</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m03_gamlss</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; ******************************************************************
#&gt; Family:  c("NBI", "Negative Binomial type I") 
#&gt; 
#&gt; Call:  gamlss(formula = Claims ~ re(fixed = ~ps(Precipitation) +  
#&gt;     Week + ps(Precipitation_lag1), random = ~1 | City,  
#&gt;     correlation = corARMA(form = ~Week | City, q = 3),  
#&gt;     method = "REML"), sigma.formula = ~ps(Week), family = NBI,  
#&gt;     data = Insurance_noNA, control = gamlss.control(c.crit = 0.01,  
#&gt;         trace = FALSE), i.control = glim.control(cc = 0.01,  
#&gt;         bf.cyc = 100, bf.tol = 0.01)) 
#&gt; 
#&gt; Fitting method: RS() 
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; Mu link function:  log
#&gt; Mu Coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)   1.1723     0.0329    35.6   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; Sigma link function:  log
#&gt; Sigma Coefficients:
#&gt;              Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)  0.115810   0.201071    0.58     0.56    
#&gt; ps(Week)    -0.003421   0.000684   -5.00  7.8e-07 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; ------------------------------------------------------------------
#&gt; NOTE: Additive smoothing terms exist in the formulas: 
#&gt;  i) Std. Error for smoothers are for the linear effect only. 
#&gt; ii) Std. Error for the linear terms maybe are not accurate. 
#&gt; ------------------------------------------------------------------
#&gt; No. of observations in the fit:  519 
#&gt; Degrees of Freedom for the fit:  9
#&gt;       Residual Deg. of Freedom:  510 
#&gt;                       at cycle:  5 
#&gt;  
#&gt; Global Deviance:     2240 
#&gt;             AIC:     2258 
#&gt;             SBC:     2296 
#&gt; ******************************************************************</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m03_gamlss</span>, ts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>#&gt; ******************************************************************
#&gt;   Summary of the Randomised Quantile Residuals
#&gt;                            mean   =  0.0141 
#&gt;                        variance   =  0.924 
#&gt;                coef. of skewness  =  0.446 
#&gt;                coef. of kurtosis  =  5.68 
#&gt; Filliben correlation coefficient  =  0.987 
#&gt; ******************************************************************</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-m03gamlssRES" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="l09_tsreg2_files/figure-html/fig-m03gamlssRES-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.18: Residual diagnostics of the GAMLSS for the number of home insurance claims.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Hence, compared with the GARMA model from the previous section, the GAMLSS <a href="#eq-GAMLSSins">Equation&nbsp;<span>9.14</span></a> uses the same predictors and distribution family and specifies ARMA(0,3) dependence in the residuals. What differs is that the GAMLSS allows nonlinear relationships between the number of claims and precipitation and models the variability changing nonlinearly across weeks.</p>
</div>
</div>
</section><section id="sec-Granger" class="level2" data-number="9.7"><h2 data-number="9.7" class="anchored" data-anchor-id="sec-Granger">
<span class="header-section-number">9.7</span> Granger causality</h2>
<p>The Granger causality <span class="citation" data-cites="Granger:1969 Kirchgassner:Wolters:2007">(<a href="references.html#ref-Granger:1969" role="doc-biblioref">Granger 1969</a>; <a href="references.html#ref-Kirchgassner:Wolters:2007" role="doc-biblioref">Kirchgässner and Wolters 2007</a>)</span> concept is based on predictability, which is why we should consider it in the time series course. Pearl causality is based on the analysis of interventions <span class="citation" data-cites="Rebane:Pearl:1987 Pearl:2009">(<a href="references.html#ref-Rebane:Pearl:1987" role="doc-biblioref">Rebane and Pearl 1987</a>; <a href="references.html#ref-Pearl:2009" role="doc-biblioref">Pearl 2009</a>)</span>.</p>
<p>Let <span class="math inline">\(I_t\)</span> be the total information set available at the time <span class="math inline">\(t\)</span>. This information set includes the two time series <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. Let <span class="math inline">\(\bar{X}_t\)</span> be the set of all current and past values of <span class="math inline">\(X\)</span>, i.e., <span class="math inline">\(\bar{X}_t = \{X_{t}, X_{t-1}, \dots, X_{t-k}, \dots \}\)</span> and analogously of <span class="math inline">\(Y\)</span>. Let <span class="math inline">\(\sigma^2(\cdot)\)</span> be the variance of the corresponding forecast error.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Difference of two sets, <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>, is denoted by <span class="math inline">\(A \setminus B\)</span>; but sometimes the minus sign is used, <span class="math inline">\(A - B\)</span>.</p>
</div>
</div>
<p><strong>Granger causality</strong></p>
<p><span class="math inline">\(X\)</span> is (simply) Granger causal to <span class="math inline">\(Y\)</span> if future values of <span class="math inline">\(Y\)</span> can be predicted better, i.e., with a smaller forecast error variance, if current and past values of <span class="math inline">\(X\)</span> are used: <span id="eq-Granger"><span class="math display">\[
\sigma^2(Y_{t+1}|I_t) &lt; \sigma^2(Y_{t+1}|I_t \setminus \bar{X}_t).
\tag{9.15}\]</span></span></p>
<p><strong>Instantaneous Granger causality</strong></p>
<p><span class="math inline">\(X\)</span> is instantaneously Granger causal to <span class="math inline">\(Y\)</span> if the future value of <span class="math inline">\(Y\)</span>, <span class="math inline">\(Y_{t+1}\)</span>, can be predicted better, i.e., with a smaller forecast error variance, if the future value of <span class="math inline">\(X\)</span>, <span class="math inline">\(X_{t+1}\)</span>, is used in addition to the current and past values of <span class="math inline">\(X\)</span>: <span id="eq-GrangerInst"><span class="math display">\[
\sigma^2(Y_{t+1}|\{I_t, X_{t+1}\}) &lt; \sigma^2(Y_{t+1}|I_t ).
\tag{9.16}\]</span></span></p>
<p><strong>Feedback</strong></p>
<p>There is feedback between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> if <span class="math inline">\(X\)</span> is causal to <span class="math inline">\(Y\)</span> and <span class="math inline">\(Y\)</span> is causal to <span class="math inline">\(X\)</span>. Feedback is only defined for the case of simple causal relations.</p>
<p>The test for <a href="#eq-Granger">Equation&nbsp;<span>9.15</span></a> and <a href="#eq-GrangerInst">Equation&nbsp;<span>9.16</span></a> is, essentially, an <span class="math inline">\(F\)</span>-test comparing two nested models: with additional predictors <span class="math inline">\(X\)</span> and without. In other words, consider the model: <span id="eq-GrangerModel"><span class="math display">\[
Y_t = \beta_0 + \sum_{k=1}^{k_1}\beta_k Y_{t-k} + \sum_{k=k_0}^{k_2}\alpha_k X_{t-k} + U_t
\tag{9.17}\]</span></span> with <span class="math inline">\(k_0 = 1\)</span>. An <span class="math inline">\(F\)</span>-test is applied to test the null hypothesis, H<span class="math inline">\(_0\)</span>: <span class="math inline">\(\alpha_1 = \alpha_2 = \dots = \alpha_{k_2} = 0\)</span>. By switching <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in <a href="#eq-GrangerModel">Equation&nbsp;<span>9.17</span></a>, it can be tested whether a simple causal relation from <span class="math inline">\(Y\)</span> to <span class="math inline">\(X\)</span> exists. There is a feedback relation if the null hypothesis is rejected in both directions (<span class="math inline">\(X\rightarrow Y\)</span> and <span class="math inline">\(Y\rightarrow X\)</span>). To test whether there is an instantaneous causality, we finally set <span class="math inline">\(k_0 = 0\)</span> and perform a <span class="math inline">\(t\)</span> or <span class="math inline">\(F\)</span>-test for the null hypothesis H<span class="math inline">\(_0\)</span>: <span class="math inline">\(\alpha_0 = 0\)</span>.</p>
<p>The problem with this test is that the results are strongly dependent on the number of lags of the explanatory variable, <span class="math inline">\(k_2\)</span>. There is a trade-off: the more lagged values we include, the better the influence of this variable can be captured. This argues for a high maximal lag. On the other hand, the power of this test is lower the more lagged values are included <span class="citation" data-cites="Kirchgassner:Wolters:2007">(Chapter 3 of <a href="references.html#ref-Kirchgassner:Wolters:2007" role="doc-biblioref">Kirchgässner and Wolters 2007</a>)</span>. Two general procedures can be used to select the lags: inspecting the sensitivity of results to different <span class="math inline">\(k_2\)</span> (sensitivity analysis) or one of the different information criteria guiding model selection.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Example: Insurance claims and precipitation Granger causality test
</div>
</div>
<div class="callout-body-container callout-body">
<p>For example, use the insurance data to test the relationships between the log-transformed home insurance number of claims and precipitation. A quick test has been performed to check that the time series are stationary and do not have a strong seasonality, so the chance of detecting spurious relationships is minimized. We can use the series in <a href="#eq-GrangerModel">Equation&nbsp;<span>9.17</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">grangertest</a></span><span class="op">(</span><span class="va">Claims_ln</span> <span class="op">~</span> <span class="va">Precipitation</span> </span>
<span>                    ,order <span class="op">=</span> <span class="fl">1</span></span>
<span>                    ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Granger causality test
#&gt; 
#&gt; Model 1: Claims_ln ~ Lags(Claims_ln, 1:1) + Lags(Precipitation, 1:1)
#&gt; Model 2: Claims_ln ~ Lags(Claims_ln, 1:1)
#&gt;   Res.Df Df    F Pr(&gt;F)   
#&gt; 1    515                  
#&gt; 2    516 -1 10.5 0.0013 **
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The low <span class="math inline">\(p\)</span>-value shows that precipitation is a Granger cause of the number of home insurance claims. Now test the reverse relationship.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">grangertest</a></span><span class="op">(</span><span class="va">Precipitation</span> <span class="op">~</span> <span class="va">Claims_ln</span>  </span>
<span>                    ,order <span class="op">=</span> <span class="fl">1</span></span>
<span>                    ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Granger causality test
#&gt; 
#&gt; Model 1: Precipitation ~ Lags(Precipitation, 1:1) + Lags(Claims_ln, 1:1)
#&gt; Model 2: Precipitation ~ Lags(Precipitation, 1:1)
#&gt;   Res.Df Df   F Pr(&gt;F)
#&gt; 1    515              
#&gt; 2    516 -1 0.2   0.65</code></pre>
</div>
</div>
<p>Reverse testing does not confirm a statistically significant Granger causality. Hence, we do not have enough evidence to claim that insurance claims are a Granger cause of precipitation (we could expect to come to this conclusion based on our knowledge of how things work), and hence there is no evidence of feedback between losses and precipitation.</p>
<p>The function <code><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">lmtest::grangertest()</a></code> does not allow us to set <code>order = 0</code> (to test instantaneous Granger causality), but we can do it manually. First, to show that ‘manual’ results match the <code><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">lmtest::grangertest()</a></code> output, repeat the test above using two nested models with lag 1.</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Claims_ln</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Claims_ln</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Precipitation</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>         ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span>
<span><span class="va">M2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Claims_ln</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Claims_ln</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>         ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">M1</span>, <span class="va">M2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Analysis of Variance Table
#&gt; 
#&gt; Model 1: Claims_ln ~ dplyr::lag(Claims_ln, 1) + dplyr::lag(Precipitation, 
#&gt;     1)
#&gt; Model 2: Claims_ln ~ dplyr::lag(Claims_ln, 1)
#&gt;   Res.Df RSS Df Sum of Sq    F Pr(&gt;F)   
#&gt; 1    515 211                            
#&gt; 2    516 215 -1     -4.32 10.5 0.0013 **
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The results match.</p>
<p>Second, test the instantaneous Granger causality in the same manner.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Claims_ln</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Claims_ln</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Precipitation</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">Precipitation</span>, data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span>
<span><span class="va">M4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Claims_ln</span> <span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Claims_ln</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">Precipitation</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>         ,data <span class="op">=</span> <span class="va">Insurance_noNA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">M3</span>, <span class="va">M4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Analysis of Variance Table
#&gt; 
#&gt; Model 1: Claims_ln ~ dplyr::lag(Claims_ln, 1) + dplyr::lag(Precipitation, 
#&gt;     1) + Precipitation
#&gt; Model 2: Claims_ln ~ dplyr::lag(Claims_ln, 1) + dplyr::lag(Precipitation, 
#&gt;     1)
#&gt;   Res.Df RSS Df Sum of Sq  F  Pr(&gt;F)    
#&gt; 1    514 203                            
#&gt; 2    515 211 -1     -7.91 20 9.5e-06 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The results show the presence of such causality.</p>
<p>As an extension to the demonstrated techniques for testing Granger causality, we may consider more complex generalized and additive models, to relax the assumptions of normality and linearity in the modeling process.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">lmtest::grangertest()</a></code> options set one value to both <span class="math inline">\(k_1\)</span> and <span class="math inline">\(k_2\)</span> in <a href="#eq-GrangerModel">Equation&nbsp;<span>9.17</span></a>. In our example, it was <span class="math inline">\(k_1 = k_2 = 1\)</span>. The ‘manual’ test using the function <code><a href="https://rdrr.io/r/stats/anova.html">anova()</a></code> can be used for models with <span class="math inline">\(k_1 = k_2\)</span> or <span class="math inline">\(k_1 \neq k_2\)</span>.</p>
</div>
</div>
</section><section id="about-predictions" class="level2" data-number="9.8"><h2 data-number="9.8" class="anchored" data-anchor-id="about-predictions">
<span class="header-section-number">9.8</span> About predictions</h2>
<p>Let <span class="math inline">\(\hat{Y}_T(h)\)</span> be a forecast <span class="math inline">\(h\)</span> steps ahead made at the time <span class="math inline">\(T\)</span>. If <span class="math inline">\(\hat{Y}_T(h)\)</span> only uses information up to time <span class="math inline">\(T\)</span>, the resulting forecasts are called out-of-sample forecasts. Economists call them <em>ex-ante</em> forecasts. We have discussed several ways to select the optimal method or model for forecasting, e.g., using PMAE, PMSE, or coverage – all calculated on a testing set. <span class="citation" data-cites="Chatfield:2000">Chatfield (<a href="references.html#ref-Chatfield:2000" role="doc-biblioref">2000</a>)</span> mentions several ways to unfairly ‘improve’ forecasts:</p>
<ol type="1">
<li>Fitting the model to all the data including the test set.</li>
<li>Fitting several models to the training set and choosing the model which gives the best ‘forecasts’ of the test set. The selected model is then used (again) to produce forecasts of the test set, even though the latter has already been used in the modeling process.</li>
<li>Using the known test-set values of ‘future’ observations on the explanatory variables in multivariate forecasting. This will improve forecasts of the dependent variable in the test set, but these future values will not of course be known at the time the forecast is supposedly made (though in practice the ‘forecast’ is made at a later date). Economists call such forecasts <em>ex-post</em> forecasts to distinguish them from <em>ex-ante</em> forecasts. The latter, being genuinely out-of-sample, use forecasts of future values of explanatory variables, where necessary, to compute forecasts of the response variable. <em>Ex-post</em> forecasts can be useful for assessing the effects of explanatory variables, provided the analyst does not pretend that they are genuine out-of-sample forecasts.</li>
</ol>
<p>So what to do if we put lots of effort to build a regression model using time series and need to forecast the response, <span class="math inline">\(Y_t\)</span>, which is modeled using different independent variables <span class="math inline">\(X_{t,k}\)</span> (<span class="math inline">\(k=1,\dots,K\)</span>)? Two options are possible.</p>
<p><strong>Leading indicators</strong></p>
<p>If <span class="math inline">\(X_{t,k}\)</span>’s are leading indicators with lags starting at <span class="math inline">\(l\)</span>, we, generally, would not need their future values to obtain the forecasts <span class="math inline">\(\hat{Y}_T(h)\)</span>, where <span class="math inline">\(h\leqslant l\)</span>. For example, the model for losses tested in <a href="#sec-Granger"><span>Section&nbsp;9.7</span></a> shows that precipitation with lag 1 is a good predictor for current losses, i.e., precipitation is a leading indicator. The 1-week ahead forecast of <span class="math inline">\(Y_{t+1}\)</span> can be obtained using the current precipitation <span class="math inline">\(X_t\)</span> (all data are available). If <span class="math inline">\(h&gt;l\)</span>, we will be forced to forecast the independent variables, <span class="math inline">\(X_{t,k}\)</span>’s – see the next option.</p>
<p><strong>Forecast of predictors</strong></p>
<p>If we opt for forecasting <span class="math inline">\(X_{t,k}\)</span>’s, the errors (uncertainty) of such forecasts will be larger, because future <span class="math inline">\(X_{t,k}\)</span>’s themselves will be the estimates. Nevertheless, it might be the only choice when leading indicators are not available. Building a full and comprehensive model with all diagnostics for each regressor is usually unfeasible and even problematic if we plan to consider multivariate models for regressors (the complexity of models will quickly escalate). As an alternative, it is common to use automatic or semi-automatic univariate procedures that can help to forecast each of the <span class="math inline">\(X_{t,k}\)</span>’s. For example, consider exponential smoothing, Holt–Winters smoothing, and auto-selected SARIMA/ARIMA/ARMA/AR/MA models – all those can be automated for a large number of forecasts to make.</p>
</section><section id="conclusion" class="level2" data-number="9.9"><h2 data-number="9.9" class="anchored" data-anchor-id="conclusion">
<span class="header-section-number">9.9</span> Conclusion</h2>
<p>Multivariate models are still much more difficult to fit than univariate ones. Multiple regression remains a treacherous procedure when applied to time series data. Many observed time series exhibit nonlinear characteristics, but nonlinear models often fail to give better out-of-sample forecasts than linear models, perhaps because the latter are more robust to departures from model assumptions. It is always a good idea to end with the so-called eyeball test. Plot the forecasts on a time plot of the data and check that they look intuitively reasonable <span class="citation" data-cites="Chatfield:2000">(<a href="references.html#ref-Chatfield:2000" role="doc-biblioref">Chatfield 2000</a>)</span>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Benjamin:etal:2003" class="csl-entry" role="doc-biblioentry">
Benjamin MA, Rigby RA, Stasinopoulos DM (2003) Generalized autoregressive moving average models. Journal of the American Statistical Association 98:214–223. <a href="https://doi.org/10.1198/016214503388619238">https://doi.org/10.1198/016214503388619238</a>
</div>
<div id="ref-Brockwell:Davis:2002" class="csl-entry" role="doc-biblioentry">
Brockwell PJ, Davis RA (2002) Introduction to time series and forecasting, 2nd edn. Springer, New York, NY, USA
</div>
<div id="ref-Chatfield:2000" class="csl-entry" role="doc-biblioentry">
Chatfield C (2000) Time-series forecasting. CRC Press, Boca Raton, FL, USA
</div>
<div id="ref-Dean:Dunsmuir:2016" class="csl-entry" role="doc-biblioentry">
Dean RT, Dunsmuir WTM (2016) Dangers and uses of cross-correlation in analyzing time series in perception, performance, movement, and neuroscience: The importance of constructing transfer function autoregressive models. Behavior Research Methods 48:783–802. <a href="https://doi.org/10.3758/s13428-015-0611-2">https://doi.org/10.3758/s13428-015-0611-2</a>
</div>
<div id="ref-Dunn:Smyth:1996" class="csl-entry" role="doc-biblioentry">
Dunn PK, Smyth GK (1996) Randomized quantile residuals. Journal of Computational and Graphical Statistics 5:236–244. <a href="https://doi.org/10.2307/1390802">https://doi.org/10.2307/1390802</a>
</div>
<div id="ref-Granger:1969" class="csl-entry" role="doc-biblioentry">
Granger CWJ (1969) Investigating causal relations by econometric models and cross-spectral methods. Econometrica 37:424–438. <a href="https://doi.org/10.2307/1912791">https://doi.org/10.2307/1912791</a>
</div>
<div id="ref-Gupta:etal:1996" class="csl-entry" role="doc-biblioentry">
Gupta PL, Gupta RC, Tripathi RC (1996) Analysis of zero-adjusted count data. Computational Statistics &amp; Data Analysis 23:207–218. <a href="https://doi.org/10.1016/S0167-9473(96)00032-1">https://doi.org/10.1016/S0167-9473(96)00032-1</a>
</div>
<div id="ref-Kirchgassner:Wolters:2007" class="csl-entry" role="doc-biblioentry">
Kirchgässner G, Wolters J (2007) <a href="https://doi.org/10.1007/978-3-540-73291-4">Introduction to modern time series analysis</a>. Springer-Verlag, Berlin, Germany
</div>
<div id="ref-Li:1994" class="csl-entry" role="doc-biblioentry">
Li WK (1994) Time series models based on generalized linear models: Some further results. Biometrics 50:506–511. <a href="https://doi.org/10.2307/2533393">https://doi.org/10.2307/2533393</a>
</div>
<div id="ref-lyubchich3732840" class="csl-entry" role="doc-biblioentry">
Lyubchich V, Nesslage G (2020) <a href="https://doi.org/10.5281/zenodo.3732839"><span class="nocase">Environmental drivers of golden tilefish fisheries v1.0</span></a>. Version v1.0. Zenodo
</div>
<div id="ref-Nesslage:etal:2021:environmental" class="csl-entry" role="doc-biblioentry">
Nesslage G, Lyubchich V, Nitschke P, et al (2021) Environmental drivers of golden tilefish (<span class="nocase">Lopholatilus chamaeleonticeps</span>) commercial landings and catch-per-unit-effort. Fisheries Oceanography 30:608–622. <a href="https://doi.org/10.1111/fog.12540">https://doi.org/10.1111/fog.12540</a>
</div>
<div id="ref-Pearl:2009" class="csl-entry" role="doc-biblioentry">
Pearl J (2009) Causality: Models, reasoning, and inference, 2nd edn. Cambridge University Press, Cambridge, UK
</div>
<div id="ref-Perperoglou:etal:2019" class="csl-entry" role="doc-biblioentry">
Perperoglou A, Sauerbrei W, Abrahamowicz M, Schmid M (2019) A review of spline function procedures in <span>R</span>. BMC Medical Research Methodology 19: <a href="https://doi.org/10.1186/s12874-019-0666-3">https://doi.org/10.1186/s12874-019-0666-3</a>
</div>
<div id="ref-Rebane:Pearl:1987" class="csl-entry" role="doc-biblioentry">
Rebane G, Pearl J (1987) The recovery of causal poly-trees from statistical data. In: Proceedings of the third annual conference on uncertainty in artificial intelligence. pp 222–228
</div>
<div id="ref-Shumway:Stoffer:2017" class="csl-entry" role="doc-biblioentry">
Shumway RH, Stoffer DS (2017) <a href="https://doi.org/10.1007/978-3-319-52452-8">Time series analysis and its applications with <span>R</span> examples</a>, 4th edn. Springer, New York, NY, USA
</div>
<div id="ref-Soliman:etal:2019:influenza" class="csl-entry" role="doc-biblioentry">
Soliman M, Lyubchich V, Gel YR (2019) Complementing the power of deep learning with statistical model fusion: Probabilistic forecasting of influenza in <span>Dallas County, Texas, USA</span>. Epidemics 28:100345. <a href="https://doi.org/10.1016/j.epidem.2019.05.004">https://doi.org/10.1016/j.epidem.2019.05.004</a>
</div>
<div id="ref-Stasinopoulos:Rigby:2007" class="csl-entry" role="doc-biblioentry">
Stasinopoulos DM, Rigby RA (2007) Generalized additive models for location scale and shape (<span>GAMLSS</span>) in <span>R</span>. Journal of Statistical Software 23:1–46. <a href="https://doi.org/10.18637/jss.v023.i07">https://doi.org/10.18637/jss.v023.i07</a>
</div>
<div id="ref-Zeger:Qaqish:1988" class="csl-entry" role="doc-biblioentry">
Zeger SL, Qaqish B (1988) Markov regression models for time series: A quasi-likelihood approach. Biometrics 44:1019–1031. <a href="https://doi.org/10.2307/2531732">https://doi.org/10.2307/2531732</a>
</div>
<div id="ref-Zuur:etal:2009" class="csl-entry" role="doc-biblioentry">
Zuur A, Ieno EN, Walker NJ, et al (2009) <a href="https://doi.org/10.1007/978-0-387-87458-6">Mixed effects models and extensions in ecology with <span>R</span></a>. Springer, New York
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./l08_tsreg1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Time Series Regression with Trends</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./l13_spectral.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spectral Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>